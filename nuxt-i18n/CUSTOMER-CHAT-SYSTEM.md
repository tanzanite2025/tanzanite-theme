# å®¢æœèŠå¤©ç³»ç»Ÿ - å®Œæ•´å®ç°æ–¹æ¡ˆ

## ğŸ¯ éœ€æ±‚

åœ¨ GradientDockMenu ä¸­ï¼Œç¬¬ä¸€ä¸ªæŒ‰é’®ç‚¹å‡»åï¼š
- **å®¢æœç«¯**ï¼šæ˜¾ç¤ºæ‰€æœ‰å®¢æˆ·åˆ—è¡¨ â†’ ç‚¹å‡»æŸä¸ªå®¢æˆ· â†’ æ‰“å¼€è¯¥å®¢æˆ·çš„èŠå¤©çª—å£
- **ç”¨æˆ·ç«¯**ï¼šç›´æ¥æ‰“å¼€è‡ªå·±çš„èŠå¤©çª—å£

æ¯ä¸ªå®¢æˆ·çš„èŠå¤©å†…å®¹æ˜¯ç‹¬ç«‹çš„ï¼Œæ ¹æ®å®¢æˆ· ID åŠ è½½ä¸åŒçš„æ¶ˆæ¯ã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆï¼šä¸¤å±‚å¼¹çª—ç³»ç»Ÿ

### **æ¶æ„å›¾ï¼š**

```
GradientDockMenu ç¬¬ä¸€ä¸ªæŒ‰é’®ï¼ˆå®¢æœèŠå¤©ï¼‰
    â†“ ç‚¹å‡»
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CustomerListModal.vue              â”‚
â”‚  ï¼ˆå®¢æˆ·åˆ—è¡¨å¼¹çª—ï¼‰                    â”‚
â”‚                                     â”‚
â”‚  ğŸ” æœç´¢å®¢æˆ·...                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ‘¤ å¼ ä¸‰  [2æ¡æœªè¯»]           â”‚ â† ç‚¹å‡»
â”‚  â”‚ æœ€åæ¶ˆæ¯: ä½ å¥½...            â”‚   â”‚
â”‚  â”‚ 2åˆ†é’Ÿå‰                      â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ ğŸ‘¤ æå››  [5æ¡æœªè¯»]           â”‚   â”‚
â”‚  â”‚ æœ€åæ¶ˆæ¯: è®¢å•é—®é¢˜...        â”‚   â”‚
â”‚  â”‚ 10åˆ†é’Ÿå‰                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ ç‚¹å‡»æŸä¸ªå®¢æˆ·
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WhatsAppChatModal.vue              â”‚
â”‚  ï¼ˆèŠå¤©çª—å£ - ä¸å¼ ä¸‰çš„å¯¹è¯ï¼‰         â”‚
â”‚                                     â”‚
â”‚  â† è¿”å›    å¼ ä¸‰  [åœ¨çº¿]             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  ğŸ‘¤ å¼ ä¸‰: ä½ å¥½ï¼Œæˆ‘æƒ³å’¨è¯¢...         â”‚
â”‚  ğŸ‘¨â€ğŸ’¼ å®¢æœ: æ‚¨å¥½ï¼Œè¯·é—®æœ‰ä»€ä¹ˆ...      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  [è¾“å…¥æ¶ˆæ¯...]            [å‘é€]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
components/
â”œâ”€â”€ GradientDockMenu.vue          # ä¿®æ”¹ï¼šæ·»åŠ å®¢æœèŠå¤©æŒ‰é’®
â”œâ”€â”€ CustomerListModal.vue         # æ–°å»ºï¼šå®¢æˆ·åˆ—è¡¨å¼¹çª—
â””â”€â”€ WhatsAppChatModal.vue         # æ–°å»ºï¼šèŠå¤©çª—å£

composables/
â””â”€â”€ useChat.ts                    # æ–°å»ºï¼šèŠå¤©çŠ¶æ€ç®¡ç†
```

---

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½

### **1. useChat.ts - èŠå¤©çŠ¶æ€ç®¡ç†**

**åŠŸèƒ½ï¼š**
- ç®¡ç†å®¢æˆ·åˆ—è¡¨ï¼ˆä¼šè¯åˆ—è¡¨ï¼‰
- ç®¡ç†å½“å‰èŠå¤©çš„æ¶ˆæ¯
- å‘é€æ¶ˆæ¯
- æ ‡è®°å·²è¯»
- å®æ—¶è½®è¯¢æ–°æ¶ˆæ¯

**API ç«¯ç‚¹ï¼š**
```typescript
GET  /wp-json/mytheme/v1/chat/conversations      // è·å–ä¼šè¯åˆ—è¡¨
GET  /wp-json/mytheme/v1/chat/messages/{id}      // è·å–æ¶ˆæ¯åˆ—è¡¨
POST /wp-json/mytheme/v1/chat/send               // å‘é€æ¶ˆæ¯
POST /wp-json/mytheme/v1/chat/mark-read/{id}     // æ ‡è®°å·²è¯»
GET  /wp-json/mytheme/v1/chat/unread-count       // è·å–æœªè¯»æ•°
```

**ä¸»è¦æ–¹æ³•ï¼š**
```typescript
const {
  conversations,          // å®¢æˆ·åˆ—è¡¨
  currentConversation,    // å½“å‰èŠå¤©çš„å®¢æˆ·
  messages,               // å½“å‰èŠå¤©çš„æ¶ˆæ¯åˆ—è¡¨
  totalUnreadCount,       // æ€»æœªè¯»æ¶ˆæ¯æ•°
  
  openCustomerList(),     // æ‰“å¼€å®¢æˆ·åˆ—è¡¨
  openChat(conversation), // æ‰“å¼€èŠå¤©çª—å£
  sendMessage(id, msg),   // å‘é€æ¶ˆæ¯
  startPolling(),         // å¼€å§‹è½®è¯¢æ–°æ¶ˆæ¯
} = useChat()
```

---

### **2. CustomerListModal.vue - å®¢æˆ·åˆ—è¡¨**

**åŠŸèƒ½ï¼š**
- æ˜¾ç¤ºæ‰€æœ‰å®¢æˆ·çš„ä¼šè¯
- æ˜¾ç¤ºæ¯ä¸ªå®¢æˆ·çš„æœªè¯»æ¶ˆæ¯æ•°
- æœç´¢å®¢æˆ·
- æ˜¾ç¤ºæœ€åä¸€æ¡æ¶ˆæ¯å’Œæ—¶é—´
- ç‚¹å‡»å®¢æˆ·æ‰“å¼€èŠå¤©çª—å£

**UI ç‰¹æ€§ï¼š**
- å®¢æˆ·å¤´åƒï¼ˆé¦–å­—æ¯ï¼‰
- æœªè¯»æ¶ˆæ¯å¾½ç« 
- æœ€åæ¶ˆæ¯é¢„è§ˆ
- ä¼šè¯çŠ¶æ€ï¼ˆè¿›è¡Œä¸­/å·²å…³é—­/å¾…å¤„ç†ï¼‰
- å®æ—¶æœç´¢è¿‡æ»¤

---

### **3. WhatsAppChatModal.vue - èŠå¤©çª—å£**

**åŠŸèƒ½ï¼š**
- æ˜¾ç¤ºä¸æŸä¸ªå®¢æˆ·çš„æ‰€æœ‰æ¶ˆæ¯
- å‘é€æ–°æ¶ˆæ¯
- è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
- è¿”å›å®¢æˆ·åˆ—è¡¨
- æ˜¾ç¤ºå®¢æˆ·ä¿¡æ¯

**æ¶ˆæ¯æ ·å¼ï¼š**
- å®¢æœæ¶ˆæ¯ï¼šå³ä¾§ï¼Œè“ç´«æ¸å˜èƒŒæ™¯
- å®¢æˆ·æ¶ˆæ¯ï¼šå·¦ä¾§ï¼Œç™½è‰²èƒŒæ™¯

---

### **4. GradientDockMenu.vue - é›†æˆ**

**ä¿®æ”¹ï¼š**
- ç¬¬ä¸€ä¸ªæŒ‰é’®æ”¹ä¸ºå®¢æœèŠå¤©æŒ‰é’®
- æ˜¾ç¤ºæœªè¯»æ¶ˆæ¯å¾½ç« 
- ç‚¹å‡»æ‰“å¼€å®¢æˆ·åˆ—è¡¨
- ç§»é™¤æ—§çš„ FAB èœå•

---

## ğŸš€ ä½¿ç”¨æµç¨‹

### **å®¢æœç«¯æµç¨‹ï¼š**

```
1. å®¢æœç‚¹å‡» GradientDockMenu ç¬¬ä¸€ä¸ªæŒ‰é’®
   â†“
2. æ‰“å¼€ CustomerListModalï¼ˆå®¢æˆ·åˆ—è¡¨ï¼‰
   - æ˜¾ç¤ºæ‰€æœ‰å®¢æˆ·
   - æ˜¾ç¤ºæœªè¯»æ¶ˆæ¯æ•°
   â†“
3. å®¢æœç‚¹å‡»æŸä¸ªå®¢æˆ·ï¼ˆä¾‹å¦‚ï¼šå¼ ä¸‰ï¼‰
   â†“
4. æ‰“å¼€ WhatsAppChatModalï¼ˆèŠå¤©çª—å£ï¼‰
   - åŠ è½½å¼ ä¸‰çš„æ‰€æœ‰æ¶ˆæ¯
   - æ ‡è®°ä¸ºå·²è¯»
   â†“
5. å®¢æœè¾“å…¥æ¶ˆæ¯å¹¶å‘é€
   â†“
6. æ¶ˆæ¯å®æ—¶æ·»åŠ åˆ°èŠå¤©çª—å£
   â†“
7. å®¢æœå¯ä»¥è¿”å›å®¢æˆ·åˆ—è¡¨é€‰æ‹©å…¶ä»–å®¢æˆ·
```

---

## ğŸ’¾ æ•°æ®ç»“æ„

### **Conversationï¼ˆä¼šè¯ï¼‰ï¼š**

```typescript
{
  id: 123,
  customer_id: 456,
  customer_name: "å¼ ä¸‰",
  customer_avatar: "https://...",
  agent_id: 789,
  status: "active",           // active | closed | pending
  unread_count: 2,
  last_message: "ä½ å¥½ï¼Œæˆ‘æƒ³å’¨è¯¢...",
  last_message_time: "2024-01-01 10:30:00",
  created_at: "2024-01-01 10:00:00",
  updated_at: "2024-01-01 10:30:00"
}
```

### **ChatMessageï¼ˆæ¶ˆæ¯ï¼‰ï¼š**

```typescript
{
  id: 1,
  conversation_id: 123,
  sender_id: 456,
  sender_name: "å¼ ä¸‰",
  sender_avatar: "https://...",
  message: "ä½ å¥½ï¼Œæˆ‘æƒ³å’¨è¯¢è®¢å•é—®é¢˜",
  attachment_url: null,
  created_at: "2024-01-01 10:30:00",
  is_read: true,
  is_agent: false             // false = å®¢æˆ·ï¼Œtrue = å®¢æœ
}
```

---

## ğŸ”„ å®æ—¶æ›´æ–°

### **æ–¹æ¡ˆ Aï¼šè½®è¯¢ï¼ˆå·²å®ç°ï¼‰**

```typescript
// æ¯ 5 ç§’è½®è¯¢ä¸€æ¬¡
const stopPolling = startPolling(5000)

// åœæ­¢è½®è¯¢
onBeforeUnmount(() => {
  stopPolling()
})
```

### **æ–¹æ¡ˆ Bï¼šWebSocketï¼ˆæ¨èï¼‰**

```typescript
// å»ºç«‹ WebSocket è¿æ¥
const ws = new WebSocket('wss://example.com/chat')

ws.onmessage = (event) => {
  const data = JSON.parse(event.data)
  
  if (data.type === 'new_message') {
    // æ·»åŠ æ–°æ¶ˆæ¯
    messages.value.push(data.message)
  }
  
  if (data.type === 'conversation_update') {
    // æ›´æ–°ä¼šè¯åˆ—è¡¨
    loadConversations()
  }
}
```

---

## ğŸ¨ UI ç‰¹æ€§

### **æœªè¯»æ¶ˆæ¯å¾½ç« ï¼š**

```vue
<!-- GradientDockMenu æŒ‰é’®ä¸Š -->
<span
  v-if="totalUnreadCount > 0"
  class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full"
>
  {{ totalUnreadCount > 9 ? '9+' : totalUnreadCount }}
</span>
```

### **å®¢æˆ·å¤´åƒï¼ˆé¦–å­—æ¯ï¼‰ï¼š**

```typescript
const getInitials = (name: string) => {
  if (!name) return '?'
  const parts = name.split(' ')
  if (parts.length >= 2) {
    return (parts[0][0] + parts[1][0]).toUpperCase()
  }
  return name.substring(0, 2).toUpperCase()
}
```

### **æ—¶é—´æ ¼å¼åŒ–ï¼š**

```typescript
const formatTime = (time: string) => {
  const diff = now.getTime() - date.getTime()
  const minutes = Math.floor(diff / 60000)
  
  if (minutes < 1) return 'åˆšåˆš'
  if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`
  if (hours < 24) return `${hours}å°æ—¶å‰`
  if (days < 7) return `${days}å¤©å‰`
  
  return date.toLocaleDateString('zh-CN')
}
```

---

## ğŸ“± å“åº”å¼è®¾è®¡

### **ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼š**

- å®¢æˆ·åˆ—è¡¨ï¼šå…¨å±æ˜¾ç¤º
- èŠå¤©çª—å£ï¼šå…¨å±æ˜¾ç¤º
- æœç´¢æ¡†ï¼šå…¨å®½
- æ¶ˆæ¯æ°”æ³¡ï¼šæœ€å¤§å®½åº¦ 70%

### **æ¡Œé¢ç«¯ï¼š**

- å®¢æˆ·åˆ—è¡¨ï¼šæœ€å¤§å®½åº¦ 2xlï¼ˆ672pxï¼‰
- èŠå¤©çª—å£ï¼šæœ€å¤§å®½åº¦ 2xlï¼ˆ672pxï¼‰
- é«˜åº¦ï¼šæœ€å¤§ 80vh

---

## ğŸ” æƒé™æ§åˆ¶

### **åç«¯ API æƒé™ï¼š**

```php
// åªæœ‰ç™»å½•ç”¨æˆ·å¯ä»¥è®¿é—®
'permission_callback' => 'is_user_logged_in'

// æˆ–è€…æ£€æŸ¥ç”¨æˆ·è§’è‰²
'permission_callback' => function() {
    return current_user_can('manage_chat');
}
```

### **å‰ç«¯è§’è‰²åˆ¤æ–­ï¼š**

```typescript
const { user } = useAuth()

// åˆ¤æ–­æ˜¯å¦æ˜¯å®¢æœ
const isAgent = computed(() => {
  return user.value?.roles?.includes('agent')
})

// å®¢æœç«¯æ˜¾ç¤ºå®¢æˆ·åˆ—è¡¨
// ç”¨æˆ·ç«¯ç›´æ¥æ‰“å¼€èŠå¤©
if (isAgent.value) {
  openCustomerList()
} else {
  openChat(myConversation)
}
```

---

## ğŸ¯ æ‰©å±•åŠŸèƒ½

### **1. å›¾ç‰‡å‘é€ï¼š**

```typescript
const sendImage = async (file: File) => {
  // ä¸Šä¼ å›¾ç‰‡åˆ° WordPress åª’ä½“åº“
  const formData = new FormData()
  formData.append('file', file)
  
  const response = await $fetch('/wp-json/wp/v2/media', {
    method: 'POST',
    body: formData,
    credentials: 'include'
  })
  
  // å‘é€æ¶ˆæ¯æ—¶é™„å¸¦å›¾ç‰‡ URL
  await sendMessage(conversationId, 'å‘é€äº†ä¸€å¼ å›¾ç‰‡', response.source_url)
}
```

### **2. æ¨é€é€šçŸ¥ï¼š**

```typescript
// è¯·æ±‚é€šçŸ¥æƒé™
if ('Notification' in window) {
  Notification.requestPermission()
}

// æ”¶åˆ°æ–°æ¶ˆæ¯æ—¶æ˜¾ç¤ºé€šçŸ¥
if (Notification.permission === 'granted') {
  new Notification('æ–°æ¶ˆæ¯', {
    body: message.message,
    icon: message.sender_avatar
  })
}
```

### **3. æ¶ˆæ¯å·²è¯»çŠ¶æ€ï¼š**

```typescript
// æ˜¾ç¤ºå·²è¯»/æœªè¯»
<div class="text-xs text-gray-500">
  {{ message.is_read ? 'å·²è¯»' : 'æœªè¯»' }}
</div>
```

---

## âœ… å®Œæˆæ¸…å•

- [x] åˆ›å»º `useChat.ts` çŠ¶æ€ç®¡ç†
- [x] åˆ›å»º `CustomerListModal.vue` å®¢æˆ·åˆ—è¡¨
- [x] åˆ›å»º `WhatsAppChatModal.vue` èŠå¤©çª—å£
- [x] ä¿®æ”¹ `GradientDockMenu.vue` é›†æˆæŒ‰é’®
- [x] æ·»åŠ æœªè¯»æ¶ˆæ¯å¾½ç« 
- [x] å®ç°æœç´¢åŠŸèƒ½
- [x] å®ç°æ¶ˆæ¯å‘é€
- [x] å®ç°è‡ªåŠ¨æ»šåŠ¨
- [x] å®ç°è½®è¯¢æ›´æ–°
- [x] å“åº”å¼è®¾è®¡

---

## ğŸ‰ æ€»ç»“

**ç°åœ¨ä½ æœ‰äº†ä¸€ä¸ªå®Œæ•´çš„å®¢æœèŠå¤©ç³»ç»Ÿï¼**

### **æ ¸å¿ƒç‰¹æ€§ï¼š**
- âœ… å®¢æˆ·åˆ—è¡¨æ˜¾ç¤ºæ‰€æœ‰ä¼šè¯
- âœ… æ¯ä¸ªå®¢æˆ·ç‹¬ç«‹çš„èŠå¤©çª—å£
- âœ… å®æ—¶æœªè¯»æ¶ˆæ¯æé†’
- âœ… æœç´¢å®¢æˆ·åŠŸèƒ½
- âœ… æ¶ˆæ¯å®æ—¶æ›´æ–°
- âœ… å“åº”å¼è®¾è®¡

### **ä½¿ç”¨æ–¹å¼ï¼š**
1. å®¢æœç‚¹å‡» GradientDockMenu ç¬¬ä¸€ä¸ªæŒ‰é’®
2. æŸ¥çœ‹å®¢æˆ·åˆ—è¡¨
3. ç‚¹å‡»æŸä¸ªå®¢æˆ·
4. å¼€å§‹èŠå¤©
5. è¿”å›åˆ—è¡¨é€‰æ‹©å…¶ä»–å®¢æˆ·

**æ¯ä¸ªå®¢æˆ·çš„èŠå¤©å†…å®¹å®Œå…¨ç‹¬ç«‹ï¼Œæ ¹æ® conversation_id åŠ è½½ä¸åŒçš„æ¶ˆæ¯ï¼** ğŸ’¬âœ¨
