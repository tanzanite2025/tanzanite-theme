# Tanzanite Settings 插件开发规划

## 1. 项目背景
- **目标**：在 WordPress 后台提供 “Tanzanite Settings” 菜单，为 Nuxt 前端商城输出统一的商品、订单、物流管理能力。
- **定位**：基于 WordPress 文章、自定义字段与自定义表，实现运营管理与专属 REST API，支撑 Nuxt 前端单页面应用。
- **核心模块**：Product（商品管理）、Orders（订单管理）、Logistics（物流与配送）。

## 2. 后台菜单结构
```
Tanzanite Settings
├─ Product
│  ├─ All Products
│  ├─ Attributes
│  ├─ Reviews
│  ├─ Add New Product
│  └─ Payment Method
├─ Orders
│  └─ All Orders
└─ Logistics
   ├─ Shipping Templates
   └─ Carriers & Tracking
```
> 子菜单名称可在实际开发时做微调，但需覆盖思维导图列出的功能点。

---

## 3. Product 模块

### 3.1 All Products（商品列表）
- **概览统计**：总商品数、上架/下架、库存预警、待审核评价等。
- **列表字段**：缩略图、商品名、SKU/ID、分类/标签、价格（原价/现价/会员价）、库存、积分、状态、更新时间。
- **筛选/搜索**：按商品名、SKU、分类、标签、状态、库存区间、积分区间、属性、创建人等过滤；支持按价格/库存/更新时间排序。
- **批量操作**：上架/下架、批量调价（绝对值/百分比）、调整库存、设置推荐位、删除、导出选中。
- **单项操作**：编辑、预览（跳转 Nuxt）、复制、置顶、快速修改价/库存/积分、查看 API payload。
- **显示方式**：支持表格与卡片视图切换，分页 20/50/100 条。

### 3.2 Attributes（商品属性）
- 使用自定义分类法管理属性组（颜色、材质等）与属性值。
- 新增/编辑属性值时支持设置 slug、显示顺序、色块/图标、是否参与前端筛选。
- 支持排序、CSV/JSON 导入导出、批量启用禁用。
- 可标记属性是否影响 SKU 组合与库存。

### 3.3 Reviews（商品评价）
- 列表字段：商品、用户/匿名、评分、评论内容、图片、状态、是否展示。
- 操作：审核通过/拒绝、标记精华、后台回复、隐藏/删除。
- 筛选：按评价来源、评分、时间、商品、关键词过滤。
- REST API：提供前端可用的评价列表输出。

### 3.4 Add New Product（新建/编辑商品）
- **基础信息**：标题、摘要、长描述、slug。
- **详情编辑器**：详情模块预留 ≥900px 高度，提供 Markdown 编辑能力，支持 H1-H7、粗体、列表、图片等富文本排版，并与前端渲染保持一致。
- **媒体**：主图、图库、视频/3D 链接。
- **价格/活动**：原价、现价、会员价、限购、起购、阶梯价、积分抵扣上限。
- **库存与规格**：总库存、预警值、允许超卖、SKU 组合（颜色/尺寸等）及其价格、条码、重量、体积。
- **积分与会员**：沿用 `mytheme-member-profiles` 插件的会员等级与积分配置，仅为商品单独记录赠送倍数、抵扣上限、适用等级等差异化字段，避免重复维护。
- **物流**：关联配送模板、是否包邮、发货时效、跨境/冷链标签。
- **SEO/营销联动**：需与 `mytheme-seo` 插件的数据保持同步，标记当前商品已配置与未配置的 SEO 字段，避免重复维护与信息不一致。
- **发布选项**：状态、发布时间、置顶、专题频道。
- **API 预览**：保存后可查看 REST 输出样例，方便与 Nuxt 联调。

### 3.5 Payment Method（支付方式）
- 配置支付名称、图标、说明、手续费、支持货币、启用状态、排序。
- 标记适用终端（PC/H5/App）、可见会员等级。
- 输出 REST 接口供 Nuxt 下单时读取可用支付方式。
-可以自定义支持的货币，用于支持前端NUXT应用调用
- 增加一个税率设置，针对不同国家，自定义税率，用于商品结账和新建商品中调用模板进行税率的后台设置联通【新建商品页面中采用勾选方式来决定是否应用税率】


---

## 4. Orders 模块

### 4.1 All Orders（订单列表）
- **字段**：订单号、下单时间、客户信息（姓名/电话/会员等级）、渠道来源、支付方式、金额明细（商品、运费、优惠、积分、实付）、订单状态、发货状态、售后状态。
- **状态流转**：待支付 → 已支付 → 待发货 → 已发货 → 已完成；覆盖取消、拒收、退款、退货中、退款完成等。
- **筛选/搜索**：按状态、时间、渠道、支付方式、客户、物流公司、优惠券/积分使用情况过滤。
- **批量操作**：确认支付、打印发货单、导出、批量更新物流。
- **订单详情**：展示商品项、SKU、单价、数量、优惠、发票、备注、后台日志。
- **发货处理**：选择物流模板/公司、录入运单号、触发通知。
- **REST 支持**：订单列表、详情、状态变更、支付回调、Webhook（后续阶段）。

---

## 5. Logistics 模块

### 5.1 Shipping Templates（配送模板）
- 支持按地区、重量、件数、体积、金额区间设定运费；可配置包邮条件、配送时效说明、多语言备注。
- 模板启用/禁用、复制、排序、导出 JSON 供 Nuxt 侧同步。
- 商品编辑页可指定默认配送模板。

### 5.2 Carriers & Tracking（物流公司）
- 管理物流公司名称、编码、联系人、客服电话、追踪 URL、服务地区。
- 配置第三方物流查询 API（17TRACK API）的密钥与 Header。
- 在订单详情中生成追踪入口；预留发货后推送 Hook。

---

## 6. 系统与接口要求
- **数据结构**：商品可基于自定义文章类型 + 自定义字段；订单建议使用自定义数据表；物流模板可使用选项或自定义表。
- **REST API**：统一挂载在 `/wp-json/tanzanite/v1/` 命名空间，支持鉴权、分页、筛选参数，与 Nuxt 前端字段保持一致。
- **权限**：自定义角色（商品运营、订单客服、物流专员），可配置菜单显示与操作权限。
- **多语言/多货币**：预留多语言字段；金额统一以基础货币存储，前端可换算。
- **日志审计**：记录后台操作（修改商品/订单/物流）与 API 调用（请求、耗时、异常），便于排错。
- **通知**：预留钩子对接邮件/短信/IM，用于订单支付、发货、退款等事件。
- **系统设置**：主设置页可配置 Nuxt 前端域名、CDN、图片压缩、缓存策略、API Token 管理等。

---

## 7. 实施阶段建议
### 7.1 布局与骨架
- 先在 WordPress 左侧菜单中注册完整的 `Tanzanite Settings` 结构，确保空页面可访问。
- 各设置页统一使用宽 1500px、高 1500px 的主容器承载内容，并按子模块拆分次级容器，方便后续组件化填充。
- 全局字体统一为 14px，菜单标题允许加粗但不增加字号，保持与 Nuxt 前端文字风格一致。
- 页面内容在主容器内水平居中排布，必要时为各分区启用内部滚动条，避免溢出。
- 容器圆角、按钮高度与输入框样式沿用 `mytheme-seo` 插件的设计系统，确保后台视觉与交互一致。

### 7.2 开发阶段
1. **阶段一**：建立菜单骨架、搭建各页面的布局容器，并完成商品/订单/物流模板的基础 CRUD 与最小化 REST API。
2. **阶段二**：补齐支付方式、批量操作、导出等后台运营功能，同时完善 REST 接口权限与校验。
3. **阶段三**：上线评价管理、通知、日志审计、细粒度权限，并对接外部服务（物流查询、ERP 等）。
4. **联调建议**：与 Nuxt 前端同步字段定义，分阶段验证接口性能、权限控制与缓存策略。

### 7.3 模块隔离
- 各菜单页应保持逻辑与数据加载的独立性；当某个设置页面出现故障时，不影响其他菜单的正常使用。
- 后台保存、验证、通知等流程需按模块拆分 Hook，避免跨模块耦合导致调试困难。

---

## 8. 实施进度与待办

### 8.1 已完成内容 
- 后台整体框架与主要菜单（商品、订单、物流、SKU 导入、审计日志）已搭建，统一 1500px 版式及样式规范。
- 商品模块：支持 SKU 批量导入/预检/排序、价格回填、SKU 阶梯价管理，与 `mytheme-seo`、会员积分逻辑保持同步。
- 商品编辑页：接入 WordPress 富文本编辑器（TinyMCE + 媒体按钮），支持标题层级、图片、拖拽上传等排版能力，并在重置时同步清空内容。
- 商品编辑页：新增可视化 SKU 编辑器，提供表格预览、表单增删改、属性组合解析、重复校验与排序，并在保存时与 REST Payload 同步。
- 商品编辑页：完善 Markdown 双栏模式与会员等级多选，新增阶梯价可视化配置（模板插入、表单校验、空态提醒）以及后端 `tanzanite_settings_sanitize_tier_pricing()` 清洗逻辑，实现前后端一致的校验闭环。
- 订单模块：自定义订单与订单商品表、状态机校验、支付/发货时间戳、批量明细写入与 REST CRUD 均已落地。
- 物流模块：配送模板、物流公司管理及相关 REST 接口完成。
- 系统层：审计日志表及后台列表、/audit-logs REST、错误码统一返回（含 hint/actions），后台页面可直接展示操作建议。
- SKU Importer 页面：支持模板下载、JSON/CSV 粘贴预检与导入，导入结果写入审计日志。
- 支付方式高级配置：新建 `tanz_payment_methods` 表，提供 REST CRUD、后台管理 UI（含手续费类型/数值、终端可见、会员等级、排序、启用状态等）。
- 商品/订单批量运营：REST 批量接口（状态流转、库存增减、字段覆盖、导出）与后台批量工具页已上线，含 CSV 下载与审计日志记录。
- 评价管理中心：建立 `tanz_product_reviews` 自建表，提供列表/审核/回复/删除 REST 接口，并在后台 Reviews 页面实现筛选、分页与权限控制的一致 UI。
- 物流追踪基础设施：新增 `tanz_tracking_events` 表与 17TRACK 适配器，支持后台配置、多服务扩展、订单创建/发货实时同步、手动刷新接口及 `tanz_after_tracking_sync` 通知钩子。
- 订单 REST 与后台列表：扩展 `GET /tanzanite/v1/orders` 支持分页筛选、金额拆解、客户摘要；后台新增 “All Orders” 页面，提供筛选表单、表格与刷新物流按钮，保留批量工具入口。
- 订单详情页：后台提供完整详情视图，涵盖状态时间线、客户/金额/商品/发票信息、物流追踪、操作日志，并支持状态操作按钮与“发货处理”表单（调用 REST 实时更新并刷新界面）。

### 8.2 正在推进 / 待完成事项 
- **错误码前端映射与通知联动**：Nuxt 侧需映射错误码 → 文案/操作，并按 hint/actions 触发通知或工单（若采用前端提示）。
- **审计日志扩展**：可考虑新增导出格式、日志详情弹窗、Webhook 推送等强化能力。
- **订单管理前台化（Nuxt 联动）**：完成 Nuxt 端占位页与 REST 对接指引（客服查单、刷新物流、发货回填），并与前端对齐错误码提示方案。
- **Nuxt 联动占位与接口规范**：
  - 先行编写 REST 接口说明（请求/响应示例、字段释义、错误码映射），在仓库或文档中提供给前端。
  - Nuxt 端可创建订单列表/详情占位页：渲染核心字段、调用后台 REST，尚未完成功能处展示 “即将上线” 提示。
  - 规划 Nuxt 调用场景：客服查单（列表+详情）、发货回填（调用发货表单接口或提供专用 API）、刷新物流（触发 `/orders/{id}/tracking`）。待 Nuxt 页面准备就绪后，对接现有接口即可。
- **商品编辑体验深化（下一步）**：在现有 Markdown 双栏预览与会员等级多选，新增阶梯价可视化配置（模板插入、表单校验、空态提醒）以及后端 `tanzanite_settings_sanitize_tier_pricing()` 清洗逻辑，实现前后端一致的校验闭环。
- **商品编辑表单联通 REST**：后台/前端页面尚未搭建实际表单，需后续创建编辑表单、接入 `rest_get_product` / `rest_create_product` / `rest_update_product` 并在保存后刷新 API 预览。
- **阶段三排期准备**：通知系统落地、更多跨系统对接、批量工具前端化等功能待立项。

### 8.3 Markdown 内容校验标准
- **必填段落**：详情文案需包含「商品亮点」「规格参数」「售后保障」三个关键段落，校验时将匹配标题或正文关键字，缺失任一段落将阻止保存。
- **敏感描述**：禁止出现「国家级」「顶级保证」「100%治愈」「零风险」「最高标准」等夸张或违规承诺，检测到后需替换为合规表述。
- **占位文本**：提交时不允许保留「TODO」「待补」「占位」「示意图」「未定稿」「[图片占位]」等占位词，编辑前需替换为实际内容。
- **图片要求**：至少插入 1 张商品图片；若检测到 `placeholder`、`temp`、`todo`、`example.com`、`dummy` 等占位图链接，同样会触发校验错误。
- **富文本 & Markdown 同步**：Markdown 校验结果会同步阻止表单提交，并在通知区域展示具体缺失项；通过校验后，`content` 与 `content_markdown` 一并提交至接口，确保后端可用于二次验证与前端渲染。

> 若未来对接 Nuxt 侧提示或外部告警，仅需复用现有 REST 的 `hint / actions` 字段，无需新增 WordPress 页面。

> 本文档作为插件开发起始蓝本，后续可在此基础上细化接口契约、字段设计、数据表结构与开发排期。

## 9. 权限角色与能力矩阵（阶段二-3）

### 9.1 能力定义

| Capability | 说明 | 适用范围 |
| --- | --- | --- |
| `tanz_view_products` | 查看商品、SKU、批量工具结果 | 商品列表、REST 读取 |
| `tanz_manage_products` | 编辑商品基础字段、SKU | 商品编辑、REST 写操作 |
| `tanz_bulk_products` | 执行商品批量操作（状态、库存、导出等） | 批量工具、批量 REST |
| `tanz_view_orders` | 查看订单列表与详情 | 订单页、REST 读取 |
| `tanz_manage_orders` | 更新订单状态、编辑订单字段 | 订单编辑、REST 写操作 |
| `tanz_bulk_orders` | 批量状态流转、批量导出订单 | 批量工具、批量 REST |
| `tanz_manage_payments` | 管理支付方式配置 | 支付方式后台/REST |
| `tanz_manage_shipping` | 维护配送模板、物流公司 | 物流后台/REST |
| `tanz_view_audit_logs` | 查看审计日志 | 审计日志页面、REST |
| `tanz_manage_settings` | 修改系统级设置（预留） | 后续全局设置 |

> 管理能力默认隐含查看能力，批量能力需在具备对应管理能力的前提下授予。

### 9.2 角色映射

| 角色（ID） | 商品 | 订单 | 支付 | 物流 | 审计 | 说明 |
| --- | --- | --- | --- | --- | --- | --- |
| `tanz_product_operator` | `tanz_view_products`、`tanz_manage_products`、`tanz_bulk_products` | `tanz_view_orders` | `tanz_manage_payments`（可选） | `tanz_manage_shipping`（无） | `tanz_view_audit_logs`（可选） | 负责商品日常运营，可查看订单以核对信息 |
| `tanz_order_support` | `tanz_view_products` | `tanz_view_orders`、`tanz_manage_orders`、`tanz_bulk_orders` | `tanz_manage_payments`（无） | `tanz_manage_shipping`（无） | `tanz_view_audit_logs` | 客服/售后角色，支持批量订单处理与日志追踪 |
| `tanz_logistics_manager` | `tanz_view_products` | `tanz_view_orders` | `tanz_manage_payments`（无） | `tanz_manage_shipping` | `tanz_view_audit_logs`（可选） | 负责配送模板与物流公司维护，可查看关联订单 |
| `tanz_supervisor` | 所有能力 | 所有能力 | 所有能力 | 所有能力 | 所有能力 | 综合主管，适用于不授予 `administrator` 的站点运营负责人 |

> `administrator` 默认继承 WordPress 的最高权限，可在插件激活时直接授予全部 `tanz_*` 能力。

### 9.3 实施要点

1. 插件激活时检查并创建上述角色，或在站点已有自定义角色时允许在后台勾选授予能力。
2. 菜单展示与 REST `permission_callback` 改用对应能力判断：例如商品列表读取检查 `tanz_view_products`，批量接口检查 `tanz_bulk_products`。
3. 前端批量工具根据当前用户能力隐藏按钮或显示只读提示，REST 层在能力不足时返回统一错误码（如 `insufficient_permissions`）。
4. 记录角色与能力的升级脚本（`maybe_upgrade_schema`）以便版本迭代时自动同步。
后续要做复杂筛选、表格联动、实时刷新等，则可以考虑引入 React/Vue，以换取更好的可维护性和组件化体验。

## 10. 阶段三初步待办与扩展方向

- **通知与联动**：实现订单/库存等事件的邮件/IM 推送，定义统一的通知队列与模板系统。
- **审计日志增强**：在现有基础上增加导出格式选择、详细记录弹窗、Webhook 推送及跨系统追踪能力。
- **跨系统集成**：预留 ERP、物流追踪 API、对账系统的适配层，支持凭证同步与状态回写。
- **角色细分与操作速记**：根据运营团队反馈拆分更细的权限组合，并在 UI 中提供快捷操作与权限提示。
- **错误码前端映射**：在 Nuxt 侧落地错误码 → 文案/行动映射，结合后台 `hint/actions` 字段触发处理流程。
- **批量工具前端化（可选）**：若后续需要复杂筛选、实时刷新或表格联动，可考虑以 React/Vue 重构批量工具，复用既有 REST 能力。