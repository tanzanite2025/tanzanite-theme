# è´§å¸è¿ç§»æŒ‡å—ï¼šCNY â†’ USD

## ðŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—è¯´æ˜Žå¦‚ä½•å°† Tanzanite Settings æ’ä»¶çš„é»˜è®¤è´§å¸ä»Ž **CNYï¼ˆäººæ°‘å¸ï¼‰** æ”¹ä¸º **USDï¼ˆç¾Žå…ƒï¼‰**ã€‚

---

## âœ… å·²å®Œæˆçš„ä»£ç ä¿®æ”¹

### 1. **æ•°æ®åº“è¡¨ç»“æž„**

#### è®¢å•è¡¨ (`wp_tanz_orders`)
```sql
-- ä¹‹å‰
currency CHAR(3) NOT NULL DEFAULT 'CNY'

-- çŽ°åœ¨
currency CHAR(3) NOT NULL DEFAULT 'USD'
```
ðŸ“ æ–‡ä»¶ï¼š`includes/legacy-pages.php` ç¬¬ 541 è¡Œ

#### ç¤¼å“å¡è¡¨ (`wp_tanz_giftcards`)
```sql
-- ä¹‹å‰
currency VARCHAR(16) NOT NULL DEFAULT 'CNY'

-- çŽ°åœ¨
currency VARCHAR(16) NOT NULL DEFAULT 'USD'
```
ðŸ“ æ–‡ä»¶ï¼š`includes/legacy-pages.php` ç¬¬ 839 è¡Œ

### 2. **REST API åˆ›å»ºè®¢å•**

```php
// ä¹‹å‰
'currency' => 'CNY',

// çŽ°åœ¨
'currency' => 'USD',
```
ðŸ“ æ–‡ä»¶ï¼š`includes/rest-api/class-rest-orders-controller.php` ç¬¬ 372 è¡Œ

### 3. **å‰ç«¯æ˜¾ç¤º**

```javascript
// ä¹‹å‰
const discountValue = item.discount_type === 'percentage' ? item.amount + '%' : 'Â¥' + item.amount;

// çŽ°åœ¨
const discountValue = item.discount_type === 'percentage' ? item.amount + '%' : '$' + item.amount;
```
ðŸ“ æ–‡ä»¶ï¼š`assets/js/rewards.js` ç¬¬ 107 è¡Œ

---

## ðŸ”„ æ•°æ®åº“è¿ç§»

### æ–¹æ³• 1ï¼šä½¿ç”¨ PHP è¿ç§»è„šæœ¬ï¼ˆæŽ¨èï¼‰

1. **è®¿é—®è¿ç§»é¡µé¢**
   ```
   http://your-site.com/wp-content/plugins/tanzanite-setting/migrate-currency-to-usd.php
   ```

2. **æŸ¥çœ‹è¿ç§»æŠ¥å‘Š**
   - è„šæœ¬ä¼šæ˜¾ç¤ºå½“å‰æ•°æ®åº“çŠ¶æ€
   - æ˜¾ç¤ºå„è´§å¸çš„è®¢å•å’Œç¤¼å“å¡æ•°é‡
   - é»˜è®¤åªæ›´æ–°è¡¨ç»“æž„ï¼Œä¸ä¿®æ”¹çŽ°æœ‰æ•°æ®

3. **ï¼ˆå¯é€‰ï¼‰æ›´æ–°çŽ°æœ‰æ•°æ®**
   - ç¼–è¾‘ `migrate-currency-to-usd.php`
   - å–æ¶ˆæ³¨é‡Šç›¸å…³ä»£ç æ®µ
   - é‡æ–°è¿è¡Œè„šæœ¬

4. **å®ŒæˆåŽåˆ é™¤è„šæœ¬**
   ```bash
   rm migrate-currency-to-usd.php
   ```

### æ–¹æ³• 2ï¼šæ‰‹åŠ¨æ‰§è¡Œ SQL

1. **å¤‡ä»½æ•°æ®åº“**
   ```bash
   mysqldump -u username -p database_name > backup.sql
   ```

2. **æ‰§è¡Œ SQL è„šæœ¬**
   ```bash
   mysql -u username -p database_name < update-currency-to-usd.sql
   ```

3. **ï¼ˆå¯é€‰ï¼‰æ›´æ–°çŽ°æœ‰æ•°æ®**
   ```sql
   -- æ›´æ–°è®¢å•
   UPDATE `wp_tanz_orders` SET `currency` = 'USD' WHERE `currency` = 'CNY';
   
   -- æ›´æ–°ç¤¼å“å¡
   UPDATE `wp_tanz_giftcards` SET `currency` = 'USD' WHERE `currency` = 'CNY';
   ```

---

## ðŸ“Š å½±å“èŒƒå›´

### âœ… å·²ä¿®æ”¹

| ç»„ä»¶ | å½±å“ | çŠ¶æ€ |
|------|------|------|
| è®¢å•è¡¨é»˜è®¤è´§å¸ | æ–°è®¢å•å°†ä½¿ç”¨ USD | âœ… å·²ä¿®æ”¹ |
| ç¤¼å“å¡è¡¨é»˜è®¤è´§å¸ | æ–°ç¤¼å“å¡å°†ä½¿ç”¨ USD | âœ… å·²ä¿®æ”¹ |
| REST API åˆ›å»ºè®¢å• | æ–°è®¢å•é»˜è®¤ USD | âœ… å·²ä¿®æ”¹ |
| ä¼˜æƒ åˆ¸æ˜¾ç¤º | æ˜¾ç¤º $ ç¬¦å· | âœ… å·²ä¿®æ”¹ |

### âš ï¸ éœ€è¦æ³¨æ„

| é¡¹ç›® | è¯´æ˜Ž |
|------|------|
| çŽ°æœ‰è®¢å• | ä¸ä¼šè‡ªåŠ¨æ›´æ–°ï¼Œéœ€æ‰‹åŠ¨æ‰§è¡Œ SQL |
| çŽ°æœ‰ç¤¼å“å¡ | ä¸ä¼šè‡ªåŠ¨æ›´æ–°ï¼Œéœ€æ‰‹åŠ¨æ‰§è¡Œ SQL |
| ä¼˜æƒ åˆ¸è¡¨ | æ— è´§å¸å­—æ®µï¼Œä½¿ç”¨è®¢å•çš„è´§å¸ |
| å‰ç«¯ Nuxt | éœ€è¦æ£€æŸ¥å‰ç«¯æ˜¯å¦æœ‰ç¡¬ç¼–ç è´§å¸ |

---

## ðŸŽ¯ ä¼˜æƒ åˆ¸ç³»ç»Ÿè¯´æ˜Ž

### ä¼˜æƒ åˆ¸å¦‚ä½•å·¥ä½œ

1. **ä¼˜æƒ åˆ¸è¡¨ç»“æž„**
   ```sql
   CREATE TABLE wp_tanz_coupons (
       id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
       code VARCHAR(64) NOT NULL,
       title VARCHAR(190) NOT NULL,
       discount_type VARCHAR(20) NOT NULL DEFAULT 'fixed_amount',
       amount DECIMAL(12,2) NOT NULL DEFAULT 0,
       -- æ³¨æ„ï¼šæ²¡æœ‰ currency å­—æ®µ
       ...
   )
   ```

2. **æŠ˜æ‰£ç±»åž‹**
   - `fixed_amount`ï¼šå›ºå®šé‡‘é¢æŠ˜æ‰£ï¼ˆå¦‚ $10ï¼‰
   - `percentage`ï¼šç™¾åˆ†æ¯”æŠ˜æ‰£ï¼ˆå¦‚ 20%ï¼‰

3. **åº”ç”¨åˆ°è®¢å•**
   ```php
   // è®¢å•è¡¨
   coupon_code VARCHAR(64) NULL,
   coupon_discount DECIMAL(18,2) NOT NULL DEFAULT 0,
   currency CHAR(3) NOT NULL DEFAULT 'USD',
   ```

4. **è®¡ç®—é€»è¾‘**ï¼ˆ`class-rest-coupons-controller.php` ç¬¬ 499-509 è¡Œï¼‰
   ```php
   if ( 'fixed_amount' === $coupon['discount_type'] ) {
       // å›ºå®šé‡‘é¢æŠ˜æ‰£ï¼ˆä½¿ç”¨è®¢å•çš„è´§å¸ï¼‰
       $discount_amount = min( floatval( $coupon['amount'] ), $subtotal );
   } elseif ( 'percentage' === $coupon['discount_type'] ) {
       // ç™¾åˆ†æ¯”æŠ˜æ‰£ï¼ˆä¸Žè´§å¸æ— å…³ï¼‰
       $discount_amount = $subtotal * ( floatval( $coupon['amount'] ) / 100 );
   }
   ```

### é‡è¦ç»“è®º

âœ… **ä¼˜æƒ åˆ¸çš„é‡‘é¢ç»§æ‰¿è®¢å•çš„è´§å¸**
- ä¼˜æƒ åˆ¸æœ¬èº«ä¸å­˜å‚¨è´§å¸ä¿¡æ¯
- å½“ä¼˜æƒ åˆ¸åº”ç”¨åˆ°è®¢å•æ—¶ï¼Œä½¿ç”¨è®¢å•çš„ `currency` å­—æ®µ
- å›ºå®šé‡‘é¢ä¼˜æƒ åˆ¸çš„ `amount` å€¼ä¼šä»¥è®¢å•è´§å¸ä¸ºå•ä½

---

## ðŸ§ª æµ‹è¯•æ¸…å•

### 1. åˆ›å»ºæ–°è®¢å•
- [ ] æ£€æŸ¥è®¢å•çš„ `currency` å­—æ®µæ˜¯å¦ä¸º `USD`
- [ ] æ£€æŸ¥è®¢å•æ€»é¢æ˜¾ç¤ºæ˜¯å¦æ­£ç¡®

### 2. åˆ›å»ºä¼˜æƒ åˆ¸
- [ ] åˆ›å»ºå›ºå®šé‡‘é¢ä¼˜æƒ åˆ¸ï¼ˆå¦‚ $10ï¼‰
- [ ] åˆ›å»ºç™¾åˆ†æ¯”ä¼˜æƒ åˆ¸ï¼ˆå¦‚ 20%ï¼‰
- [ ] æ£€æŸ¥åŽå°æ˜¾ç¤ºæ˜¯å¦æ­£ç¡®

### 3. åº”ç”¨ä¼˜æƒ åˆ¸
- [ ] åœ¨è®¢å•ä¸­åº”ç”¨å›ºå®šé‡‘é¢ä¼˜æƒ åˆ¸
- [ ] æ£€æŸ¥æŠ˜æ‰£é‡‘é¢è®¡ç®—æ˜¯å¦æ­£ç¡®
- [ ] æ£€æŸ¥ `coupon_discount` å­—æ®µå€¼

### 4. åˆ›å»ºç¤¼å“å¡
- [ ] åˆ›å»ºæ–°ç¤¼å“å¡
- [ ] æ£€æŸ¥ `currency` å­—æ®µæ˜¯å¦ä¸º `USD`
- [ ] æ£€æŸ¥ä½™é¢æ˜¾ç¤ºæ˜¯å¦æ­£ç¡®

### 5. å‰ç«¯æ˜¾ç¤º
- [ ] æ£€æŸ¥ä¼˜æƒ åˆ¸åˆ—è¡¨æ˜¾ç¤º
- [ ] æ£€æŸ¥è®¢å•è¯¦æƒ…æ˜¾ç¤º
- [ ] æ£€æŸ¥ç»“è´¦é¡µé¢æ˜¾ç¤º

---

## ðŸ“ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®ä¸€è‡´æ€§
- ä¿®æ”¹çŽ°æœ‰æ•°æ®å‰åŠ¡å¿…å¤‡ä»½
- ç¡®ä¿æ‰€æœ‰ç›¸å…³é‡‘é¢éƒ½ä½¿ç”¨ç›¸åŒè´§å¸
- æ£€æŸ¥æ˜¯å¦æœ‰æ±‡çŽ‡è½¬æ¢éœ€æ±‚

### 2. å‰ç«¯å…¼å®¹æ€§
- æ£€æŸ¥ Nuxt å‰ç«¯æ˜¯å¦æœ‰ç¡¬ç¼–ç çš„ CNY
- æ›´æ–°å‰ç«¯çš„è´§å¸ç¬¦å·æ˜¾ç¤º
- ç¡®ä¿ä»·æ ¼æ ¼å¼åŒ–å‡½æ•°ä½¿ç”¨æ­£ç¡®è´§å¸

### 3. ç¬¬ä¸‰æ–¹é›†æˆ
- æ£€æŸ¥æ”¯ä»˜ç½‘å…³é…ç½®
- æ›´æ–°æ”¯ä»˜æ–¹å¼çš„è´§å¸è®¾ç½®
- ç¡®è®¤ç¨ŽçŽ‡è®¡ç®—æ˜¯å¦å—å½±å“

---

## ðŸ”§ æ•…éšœæŽ’é™¤

### é—®é¢˜ 1ï¼šä¼˜æƒ åˆ¸é‡‘é¢æ˜¾ç¤ºé”™è¯¯
**åŽŸå› **ï¼šå‰ç«¯ JavaScript ç¼“å­˜
**è§£å†³**ï¼šæ¸…é™¤æµè§ˆå™¨ç¼“å­˜æˆ–å¼ºåˆ¶åˆ·æ–°

### é—®é¢˜ 2ï¼šè®¢å•ä»æ˜¾ç¤º CNY
**åŽŸå› **ï¼šçŽ°æœ‰è®¢å•æœªæ›´æ–°
**è§£å†³**ï¼šæ‰§è¡Œ SQL æ›´æ–°çŽ°æœ‰è®¢å•

### é—®é¢˜ 3ï¼šæŠ˜æ‰£è®¡ç®—é”™è¯¯
**åŽŸå› **ï¼šå¯èƒ½æ˜¯æ±‡çŽ‡é—®é¢˜
**è§£å†³**ï¼šæ£€æŸ¥ä¼˜æƒ åˆ¸é‡‘é¢æ˜¯å¦éœ€è¦è°ƒæ•´

---

## ðŸ“ž æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æ•°æ®åº“è¡¨ç»“æž„æ˜¯å¦æ­£ç¡®æ›´æ–°
2. PHP ä»£ç æ˜¯å¦æ­£ç¡®ä¿®æ”¹
3. JavaScript æ–‡ä»¶æ˜¯å¦å·²æ›´æ–°
4. æµè§ˆå™¨ç¼“å­˜æ˜¯å¦å·²æ¸…é™¤

---

## âœ… å®Œæˆæ£€æŸ¥è¡¨

- [x] ä¿®æ”¹è®¢å•è¡¨é»˜è®¤è´§å¸ä¸º USD
- [x] ä¿®æ”¹ç¤¼å“å¡è¡¨é»˜è®¤è´§å¸ä¸º USD
- [x] ä¿®æ”¹ REST API åˆ›å»ºè®¢å•è´§å¸ä¸º USD
- [x] ä¿®æ”¹å‰ç«¯ä¼˜æƒ åˆ¸æ˜¾ç¤ºä¸º $ ç¬¦å·
- [ ] æ‰§è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬
- [ ] æ›´æ–°çŽ°æœ‰è®¢å•è´§å¸ï¼ˆå¯é€‰ï¼‰
- [ ] æ›´æ–°çŽ°æœ‰ç¤¼å“å¡è´§å¸ï¼ˆå¯é€‰ï¼‰
- [ ] æµ‹è¯•ä¼˜æƒ åˆ¸åˆ›å»ºå’Œåº”ç”¨
- [ ] æµ‹è¯•è®¢å•ç»“è´¦æµç¨‹
- [ ] æ£€æŸ¥å‰ç«¯ Nuxt æ˜¾ç¤º

---

**æœ€åŽæ›´æ–°ï¼š** 2025-11-16
**ç‰ˆæœ¬ï¼š** 1.0.0
